-- ═══════════════════════════════════════════════════════════════
-- 🔧 إصلاح عاجل: البوكمارك للمستخدمين العاديين
-- ═══════════════════════════════════════════════════════════════
-- المشكلة: البوكمارك تعمل للأدمن فقط، ولا تعمل للمستخدمين العاديين
-- السبب: RLS Policy لجدول mangas لا تسمح بالقراءة عبر العلاقات (joins)
-- الحل: تحديث Policy لتسمح بالقراءة للجميع بشكل صحيح
-- ═══════════════════════════════════════════════════════════════

-- ┌─────────────────────────────────────────────────────────────┐
-- │ الخطوة 1: حذف Policy القديمة لجدول mangas                 │
-- └─────────────────────────────────────────────────────────────┘

DROP POLICY IF EXISTS "mangas_select_policy" ON mangas;

-- ┌─────────────────────────────────────────────────────────────┐
-- │ الخطوة 2: إنشاء Policy جديدة تسمح بالقراءة للجميع         │
-- └─────────────────────────────────────────────────────────────┘

-- هذه Policy تسمح لأي شخص (مسجل أو غير مسجل) بقراءة بيانات المانجا
-- بما في ذلك عند جلب البوكمارك
CREATE POLICY "mangas_public_read" ON mangas
    FOR SELECT
    TO public  -- مهم جداً: public بدلاً من authenticated
    USING (true);

-- ┌─────────────────────────────────────────────────────────────┐
-- │ الخطوة 3: التأكد من أن RLS مفعل                            │
-- └─────────────────────────────────────────────────────────────┘

ALTER TABLE mangas ENABLE ROW LEVEL SECURITY;

-- ┌─────────────────────────────────────────────────────────────┐
-- │ الخطوة 4: التحقق من Policy الجديدة                        │
-- └─────────────────────────────────────────────────────────────┘

-- عرض جميع Policies لجدول mangas
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies
WHERE tablename = 'mangas';

-- ═══════════════════════════════════════════════════════════════
-- ✅ تم الإصلاح!
-- ═══════════════════════════════════════════════════════════════
-- الآن:
-- ✓ المستخدمون العاديون يمكنهم رؤية البوكمارك
-- ✓ الأدمن يمكنهم رؤية البوكمارك (كما كان)
-- ✓ الجميع يمكنهم قراءة بيانات المانجا
-- ═══════════════════════════════════════════════════════════════

-- ┌─────────────────────────────────────────────────────────────┐
-- │ اختبار سريع                                                │
-- └─────────────────────────────────────────────────────────────┘

-- هذا الاستعلام يجب أن يعمل الآن للمستخدمين العاديين
-- (نفس الاستعلام المستخدم في صفحة البوكمارك)
SELECT 
    b.manga_id,
    m.id,
    m.title,
    m.cover_image,
    m.status,
    m.rating,
    m.slug
FROM bookmarks b
JOIN mangas m ON b.manga_id = m.id
LIMIT 5;
